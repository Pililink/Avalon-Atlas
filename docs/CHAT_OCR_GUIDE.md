# 聊天框 OCR 功能使用说明

## 功能概述

新增了**双热键 OCR 系统**,支持两种不同的识别模式:

### 1. 鼠标 OCR (原有功能)
- **热键**: 默认 `Ctrl+Alt+M` (可自定义)
- **用途**: 识别鼠标位置上方的单个地图名
- **使用场景**: 游戏界面中的地图图标、悬停提示等

### 2. 聊天框 OCR (新功能)
- **热键**: 默认 `Ctrl+Alt+C` (可自定义)
- **用途**: 框选聊天框区域,批量识别多个地图名
- **使用场景**: 从聊天记录中提取队友分享的地图列表

## 使用步骤

### 配置热键

1. 点击主窗口底部的 **"设置"** 按钮
2. 分别设置两个热键:
   - **鼠标 OCR 热键**: 用于识别鼠标位置
   - **聊天框 OCR 热键**: 用于框选区域识别
3. 点击 **"保存"** 应用设置

### 使用聊天框 OCR

1. **首次使用** - 框选区域:
   - 按下聊天框 OCR 热键 (如 `Ctrl+Alt+C`)
   - 屏幕会显示半透明遮罩
   - 用鼠标拖动框选聊天框区域
   - 松开鼠标完成选择

2. **自动识别**:
   - 框选完成后自动开始 OCR 识别
   - 识别到的所有地图名会自动添加到列表
   - 状态栏显示识别结果

3. **再次使用**:
   - 区域会被保存
   - 下次按相同热键直接识别该区域
   - 无需重新框选

## 实现细节

### 核心文件

- **`atlas/ui/region_selector.py`**: 区域选择器组件
  - 全屏半透明遮罩
  - 鼠标拖动框选
  - 实时显示选择区域尺寸

- **`atlas/ui/settings_dialog.py`**: 设置对话框
  - 双热键配置
  - 热键录制功能
  - OCR 调试开关

- **`atlas/services/ocr_service.py`**:
  - `capture_chat_region()`: 识别指定区域
  - `_extract_all_map_names()`: 提取多个地图名

- **`atlas/services/hotkey_service.py`**:
  - 支持注册多个热键
  - Windows 全局热键支持

### 配置文件

`config.json` 新增字段:

```json
{
  "hotkey": "ctrl+shift+q",        // 鼠标 OCR
  "chat_hotkey": "ctrl+alt+c",     // 聊天框 OCR
  "ocr_debug": true
}
```

## 技术亮点

1. **多地图名提取**: 从文本中自动识别所有地图名
2. **区域记忆**: 框选区域自动保存,下次直接使用
3. **去重处理**: 同一地图只添加一次
4. **模糊匹配**: OCR 容错,支持识别不准确的文本
5. **线程安全**: UI 更新使用 `QMetaObject.invokeMethod`

## 调试模式

启用 `ocr_debug: true` 后:
- 每次 OCR 会保存截图到 `debug/` 目录
- 聊天框 OCR 文件前缀为 `chat_*`
- 鼠标 OCR 文件前缀为 `ocr_capture_*`

查看截图和日志可以帮助诊断识别问题。

## 注意事项

1. 热键不能冲突,设置时会自动检查
2. 框选区域建议包含完整的聊天文本
3. OCR 识别质量取决于文本清晰度和字体
4. 支持中英文地图名混合识别
