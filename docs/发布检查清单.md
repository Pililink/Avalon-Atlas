# 发布检查清单

完整的版本发布流程指南，确保每次发布都符合标准。

---

## 📋 发布前准备

### 1. 版本号更新

确保以下文件中的版本号一致：

- [ ] `atlas/version.py`
  ```python
  __version__ = "1.0.0"  # 更新为新版本
  __version_info__ = (1, 0, 0)  # 更新元组
  ```

- [ ] `pyproject.toml`
  ```toml
  version = "1.0.0"  # 与 version.py 保持一致
  ```

**版本号规则**（语义化版本）：
- `1.0.0` → `1.0.1`：修复 bug（PATCH）
- `1.0.0` → `1.1.0`：新增功能（MINOR）
- `1.0.0` → `2.0.0`：重大变更（MAJOR）

### 2. 更新 CHANGELOG.md

在 `CHANGELOG.md` 中添加新版本的变更记录：

```markdown
## [1.0.1] - 2025-01-25

### 修复 (Fixed)
- 修复 OCR 识别时内存泄漏问题
- 修复热键在某些输入法下无法触发的问题

### 变更 (Changed)
- 优化搜索算法性能
```

**变更类型**：
- `Added` (新增)
- `Changed` (变更)
- `Deprecated` (弃用)
- `Removed` (移除)
- `Fixed` (修复)
- `Security` (安全)

### 3. 代码质量检查

- [ ] 运行所有测试（如果有）
  ```bash
  pytest
  ```

- [ ] 检查代码风格（如果配置了）
  ```bash
  ruff check .
  ```

- [ ] 本地构建测试
  ```bash
  python build.py
  ```

- [ ] 验证构建产物
  - 运行 `dist/AvalonAtlas/AvalonAtlas.exe`
  - 测试热键功能
  - 测试 OCR 识别
  - 测试搜索功能
  - 检查是否有控制台窗口（应该没有）

### 4. 文档检查

- [ ] README.md 版本号徽章更新（如果有）
- [ ] 文档中的示例代码可运行
- [ ] 下载链接正确（指向 Releases）
- [ ] 配置文件示例最新

---

## 🚀 发布流程

### 方式一：使用发布脚本（推荐）

```bash
# 运行发布脚本
python scripts/release.py
```

脚本会自动执行：
1. 检查 Git 工作区状态
2. 读取 `atlas/version.py` 中的版本号
3. 提示确认发布信息
4. 创建 Git 标签
5. 推送标签到远程仓库
6. 触发 GitHub Actions 自动构建

### 方式二：手动发布

```bash
# 1. 提交所有变更
git add .
git commit -m "Release v1.0.1"

# 2. 创建标签（注意：必须以 v 开头）
git tag -a v1.0.1 -m "Release v1.0.1"

# 3. 推送代码和标签
git push
git push origin v1.0.1
```

### GitHub Actions 自动流程

推送标签后，GitHub Actions 会自动：
1. ✅ 检出代码
2. ✅ 设置 Python 环境
3. ✅ 安装依赖
4. ✅ 验证版本号一致性
5. ✅ 构建可执行文件
6. ✅ 验证构建产物
7. ✅ 生成发布说明
8. ✅ 创建 GitHub Release
9. ✅ 上传便携版 ZIP

---

## 🔍 发布中监控

### 1. 查看构建进度

前往 GitHub Actions 页面：
```
https://github.com/<your-username>/atlas/actions
```

查看 "Release" 工作流的运行状态。

### 2. 构建失败处理

如果构建失败：

1. **检查错误日志**
   - 点击失败的工作流查看详细日志
   - 常见错误：依赖安装失败、版本号不一致

2. **修复问题**
   - 根据错误信息修复代码
   - 提交修复

3. **重新发布**
   - 删除失败的标签：
     ```bash
     git tag -d v1.0.1
     git push origin :refs/tags/v1.0.1
     ```
   - 重新创建标签并推送

### 3. 构建成功验证

构建成功后，检查：
- [ ] Release 页面已创建
- [ ] 便携版 ZIP 已上传
- [ ] 发布说明显示正常
- [ ] 文件大小合理（约 150-250 MB）

---

## ✅ 发布后验证

### 1. 下载测试

从 GitHub Release 下载便携版：
```
https://github.com/<your-username>/atlas/releases/tag/v1.0.1
```

### 2. 功能测试

在干净的 Windows 系统上测试：
- [ ] 解压 ZIP 文件
- [ ] 双击运行 `AvalonAtlas.exe`
- [ ] 测试搜索功能
- [ ] 测试热键录制
- [ ] 测试 OCR 识别
- [ ] 测试地图预览
- [ ] 检查配置文件生成

### 3. 用户体验检查

- [ ] 无控制台窗口
- [ ] 启动速度正常（< 5 秒）
- [ ] 界面显示正常
- [ ] 无明显错误提示
- [ ] 图标显示正确（如已添加）

### 4. 文档更新

- [ ] README.md 下载链接更新
- [ ] CHANGELOG.md 发布日期确认
- [ ] 创建发布公告（如需要）

---

## 📢 发布通知（可选）

发布完成后，可通过以下渠道通知用户：

### GitHub
- [ ] 编辑 Release 说明
- [ ] 添加更新亮点
- [ ] 附上使用截图

### 社区
- [ ] 相关论坛发布公告
- [ ] 社交媒体分享
- [ ] 用户群通知

---

## 🔄 回滚流程

如果发现严重问题需要回滚：

### 1. 标记为预发布

在 GitHub Release 页面：
- 编辑 Release
- 勾选 "Set as a pre-release"
- 添加警告说明

### 2. 删除有问题的发布

```bash
# 删除本地标签
git tag -d v1.0.1

# 删除远程标签
git push origin :refs/tags/v1.0.1

# 删除 GitHub Release（通过网页界面）
```

### 3. 发布修复版本

- 增加 PATCH 版本号（如 1.0.1 → 1.0.2）
- 在 CHANGELOG 说明修复内容
- 重新发布

---

## 📝 版本号示例

### 正式版本
- `v1.0.0` - 首个稳定版本
- `v1.1.0` - 新增功能
- `v1.0.1` - Bug 修复
- `v2.0.0` - 重大更新

### 预发布版本
- `v1.0.0-alpha.1` - 内部测试版
- `v1.0.0-beta.1` - 公开测试版
- `v1.0.0-rc.1` - 候选发布版

---

## 🎯 快速检查清单

发布前快速检查（5 分钟）：

```
✅ 版本号更新（version.py + pyproject.toml）
✅ CHANGELOG.md 更新
✅ 本地构建测试通过
✅ Git 工作区干净
✅ 功能测试通过
```

发布后快速验证（5 分钟）：

```
✅ GitHub Actions 构建成功
✅ Release 页面正常
✅ 便携版 ZIP 可下载
✅ 解压运行测试通过
✅ 主要功能正常
```

---

## 💡 最佳实践

1. **小步快跑**：频繁发布小版本，而非憋大版本
2. **测试先行**：发布前充分测试，减少回滚
3. **文档同步**：代码和文档同步更新
4. **用户沟通**：重大变更提前通知用户
5. **版本管理**：严格遵循语义化版本规范

---

## 🆘 常见问题

### Q: GitHub Actions 构建超时怎么办？
A: 检查是否是网络问题（依赖下载慢），可在工作流中添加重试逻辑。

### Q: 版本号忘记更新怎么办？
A: 删除标签，更新版本号后重新发布。

### Q: Release 创建失败但标签已推送？
A: 检查 `GITHUB_TOKEN` 权限，确保有 `contents: write` 权限。

### Q: 便携版 ZIP 过大（> 300MB）？
A: 检查是否打包了不必要的文件，考虑优化依赖或使用 UPX 压缩。

### Q: 用户下载后无法运行？
A: 检查是否被杀毒软件拦截，建议提交到 VirusTotal 获取信任。

---

## 📚 参考资源

- [语义化版本 2.0.0](https://semver.org/lang/zh-CN/)
- [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)
- [GitHub Actions 文档](https://docs.github.com/cn/actions)
- [PyInstaller 文档](https://pyinstaller.org/en/stable/)

---

**祝发布顺利！** 🎉
