# 自动发布流程图示

本文档通过图示说明 Avalon Atlas 的自动发布流程。

---

## 📊 完整发布流程

```
┌─────────────────────────────────────────────────────────────┐
│                    1. 开发者本地准备                          │
│                                                             │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────┐     │
│  │ 更新版本号   │→ │ 更新 CHANGELOG│→ │ 本地构建测试  │     │
│  └─────────────┘  └──────────────┘  └───────────────┘     │
│         │                                     │             │
│         └─────────────────┬───────────────────┘             │
└───────────────────────────┼─────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    2. 创建并推送标签                          │
│                                                             │
│            python scripts/release.py                        │
│                    或                                        │
│            git tag -a v1.0.0 -m "Release"                   │
│            git push origin v1.0.0                           │
└───────────────────────────┬─────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              3. GitHub Actions 自动触发                       │
│                                                             │
│                  检测到 v* 标签推送                           │
└───────────────────────────┬─────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  4. 环境准备 (1-2 分钟)                       │
│                                                             │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────┐     │
│  │ 检出代码仓库 │→ │ 设置 Python  │→ │ 安装项目依赖  │     │
│  └─────────────┘  └──────────────┘  └───────────────┘     │
└───────────────────────────┬─────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  5. 版本验证 (< 1 分钟)                       │
│                                                             │
│          对比 Git 标签 vs atlas/version.py                   │
│                                                             │
│           ┌─────────┐                                       │
│           │ 一致？  │                                       │
│           └────┬────┘                                       │
│          是 ──┤        否                                   │
│               │         └──→ ❌ 构建失败                     │
│               ▼                                             │
└───────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────┐
│                  6. 构建应用 (3-5 分钟)                       │
│                                                             │
│              python build.py                                │
│                                                             │
│  ┌──────────────┐  ┌───────────────┐  ┌──────────────┐   │
│  │ PyInstaller  │→ │ 打包便携版 ZIP │→ │ 验证构建产物  │   │
│  │ 打包 exe     │  │               │  │              │   │
│  └──────────────┘  └───────────────┘  └──────────────┘   │
└───────────────────────────┬─────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  7. 生成发布说明 (< 1 分钟)                   │
│                                                             │
│       从 CHANGELOG.md 提取当前版本变更内容                    │
│       添加下载说明和使用指南链接                              │
└───────────────────────────┬─────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  8. 创建 Release (< 1 分钟)                  │
│                                                             │
│  ┌──────────────┐  ┌───────────────┐  ┌──────────────┐   │
│  │ 创建 Release │→ │ 上传 ZIP 文件  │→ │ 发布成功通知  │   │
│  │  页面        │  │               │  │              │   │
│  └──────────────┘  └───────────────┘  └──────────────┘   │
└───────────────────────────┬─────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      9. 用户下载使用                          │
│                                                             │
│  GitHub Releases → 下载 ZIP → 解压 → 运行 AvalonAtlas.exe   │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 错误处理流程

```
┌─────────────────────────────────────────┐
│         构建过程中出现错误               │
└────────────────┬────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│      GitHub Actions 标记失败             │
│      发送邮件通知开发者                  │
└────────────────┬────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│      开发者查看错误日志                  │
└────────────────┬────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│      修复问题并提交代码                  │
└────────────────┬────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│      删除失败的标签                      │
│   git tag -d v1.0.0                     │
│   git push origin :refs/tags/v1.0.0     │
└────────────────┬────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│      重新创建标签并推送                  │
│   git tag -a v1.0.0 -m "Release"        │
│   git push origin v1.0.0                │
└─────────────────────────────────────────┘
```

---

## 📂 文件依赖关系

```
发布流程涉及的关键文件：

atlas/version.py
    │
    ├─→ pyproject.toml (版本号同步)
    │
    └─→ build.py (读取版本号)
            │
            └─→ dist/AvalonAtlas-v{version}-portable.zip
                    │
                    └─→ GitHub Release (上传)

CHANGELOG.md
    │
    └─→ .github/workflows/release.yml (提取发布说明)
            │
            └─→ GitHub Release (显示说明)

requirements.txt
    │
    └─→ .github/workflows/release.yml (安装依赖)

AvalonAtlas.spec
    │
    └─→ build.py (PyInstaller 配置)
```

---

## 🎯 版本号流转

```
开发阶段
    │
    ▼
atlas/version.py      ──┐
__version__ = "1.0.0"   │  保持一致
    │                   │
pyproject.toml        ──┘
version = "1.0.0"
    │
    ▼
提交代码
    │
    ▼
创建标签
git tag v1.0.0
    │
    ▼
GitHub Actions 验证
    │
    ├─→ 读取 atlas/version.py → "1.0.0"
    ├─→ 解析 git 标签 → "v1.0.0" → "1.0.0"
    └─→ 对比是否一致 ✅
    │
    ▼
构建文件名
AvalonAtlas-v1.0.0-portable.zip
    │
    ▼
Release 标题
Avalon Atlas v1.0.0
```

---

## 🚦 构建状态流转

```
┌──────────┐
│  Pending │  ← 推送标签后
└─────┬────┘
      │
      ▼
┌──────────┐
│  Running │  ← 构建中 (8-13 分钟)
└─────┬────┘
      │
      ├──────┐
      │      │
      ▼      ▼
┌──────────┐ ┌──────────┐
│  Success │ │  Failed  │
└──────────┘ └──────────┘
      │            │
      ▼            ▼
Release 创建   查看日志修复
```

---

## 🔐 权限需求

```
GitHub Actions 需要的权限：

Repository Settings
    │
    ├─→ Actions
    │   └─→ General
    │       └─→ Workflow permissions
    │           └─→ ✅ Read and write permissions
    │
    └─→ Secrets (可选)
        └─→ 存储敏感配置

工作流中声明：
permissions:
  contents: write  ← 创建 Release 需要
```

---

## 📋 时间线示例

```
发布 v1.0.0 完整时间线：

00:00  开发者运行 python scripts/release.py
00:01  脚本检查工作区状态 ✅
00:02  创建标签 v1.0.0
00:03  推送标签到 GitHub
00:04  GitHub Actions 触发构建
00:05  检出代码和设置环境
00:07  安装依赖 (pip install)
00:10  验证版本号一致性 ✅
00:11  运行 build.py 构建
00:15  PyInstaller 打包完成
00:16  创建便携版 ZIP
00:17  验证构建产物 ✅
00:18  生成发布说明
00:19  创建 GitHub Release
00:20  上传 ZIP 文件
00:21  构建完成 ✅

总耗时: 约 17 分钟 (本地 + CI)
```

---

## 💡 最佳实践流程

```
功能开发
    ↓
本地测试 ✅
    ↓
git commit
    ↓
更新版本号
    ↓
更新 CHANGELOG
    ↓
本地构建测试
    ↓
git commit (Release vX.X.X)
    ↓
python scripts/release.py
    ↓
等待 GitHub Actions
    ↓
验证 Release ✅
    ↓
通知用户
```

---

## 🎬 快速参考

### 正常发布
```bash
# 1. 更新版本
vim atlas/version.py
vim pyproject.toml
vim CHANGELOG.md

# 2. 提交
git add .
git commit -m "Release v1.0.0"

# 3. 发布
python scripts/release.py
```

### 紧急回滚
```bash
# 删除有问题的标签
git tag -d v1.0.0
git push origin :refs/tags/v1.0.0

# 删除 GitHub Release (通过网页)

# 发布修复版本
# 更新为 v1.0.1
python scripts/release.py
```

---

**参考文档**：
- [GitHub Actions 使用说明](./GitHub_Actions使用说明.md)
- [发布检查清单](./发布检查清单.md)
