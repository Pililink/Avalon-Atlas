name: Release

# è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶ï¼ˆå¦‚ v1.0.0ï¼‰
on:
  push:
    tags:
      - 'v*'

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.12'

jobs:
  build-and-release:
    name: æ„å»ºå¹¶å‘å¸ƒ Windows ä¾¿æºç‰ˆ
    runs-on: windows-latest

    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç‰ˆæœ¬ä¿¡æ¯

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || pip install pydantic pyside6 rapidfuzz pillow pytesseract mss keyboard pynput numpy rapidocr-onnxruntime pyinstaller

      # 4. éªŒè¯ç‰ˆæœ¬å·ä¸€è‡´æ€§
      - name: ğŸ” éªŒè¯ç‰ˆæœ¬å·
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''

          # è¯»å– atlas/version.py ä¸­çš„ç‰ˆæœ¬å·
          $versionFile = Get-Content "atlas/version.py" -Raw
          if ($versionFile -match '__version__\s*=\s*[''"]([^''"]+)[''"]') {
            $codeVersion = $matches[1]
            Write-Host "Git æ ‡ç­¾ç‰ˆæœ¬: $version"
            Write-Host "ä»£ç ä¸­ç‰ˆæœ¬: $codeVersion"

            if ($version -ne $codeVersion) {
              Write-Error "ç‰ˆæœ¬å·ä¸ä¸€è‡´ï¼è¯·ç¡®ä¿ git tag ä¸ atlas/version.py ä¸­çš„ç‰ˆæœ¬å·åŒ¹é…ã€‚"
              exit 1
            }
          } else {
            Write-Error "æ— æ³•ä» atlas/version.py è¯»å–ç‰ˆæœ¬å·"
            exit 1
          }

      # 5. æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      - name: ğŸ”¨ æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        run: python build.py

      # 6. æ£€æŸ¥æ„å»ºäº§ç‰©
      - name: âœ… éªŒè¯æ„å»ºäº§ç‰©
        shell: pwsh
        run: |
          $exePath = "dist/AvalonAtlas/AvalonAtlas.exe"
          $zipPath = "dist/AvalonAtlas-v${{ github.ref_name }}-portable.zip"

          if (-not (Test-Path $exePath)) {
            Write-Error "æ„å»ºå¤±è´¥ï¼šæœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
            exit 1
          }

          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          $exeSize = (Get-Item $exePath).Length / 1MB
          Write-Host "âœ“ å¯æ‰§è¡Œæ–‡ä»¶å¤§å°: $($exeSize.ToString('F2')) MB"

          if (Test-Path $zipPath) {
            $zipSize = (Get-Item $zipPath).Length / 1MB
            Write-Host "âœ“ ä¾¿æºç‰ˆå‹ç¼©åŒ…: $($zipSize.ToString('F2')) MB"
          }

          # åˆ—å‡ºå¿…éœ€æ–‡ä»¶
          Write-Host "`nå¿…éœ€æ–‡ä»¶æ£€æŸ¥:"
          $requiredPaths = @(
            "dist/AvalonAtlas/static/data/maps.json",
            "dist/AvalonAtlas/static/maps",
            "dist/AvalonAtlas/static/assets"
          )

          foreach ($path in $requiredPaths) {
            if (Test-Path $path) {
              Write-Host "  âœ“ $path"
            } else {
              Write-Error "  âœ— ç¼ºå¤±: $path"
              exit 1
            }
          }

      # 7. å‡†å¤‡å‘å¸ƒè¯´æ˜
      - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: release_notes
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"

          # ä» CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´å†…å®¹
          $changelogPath = "CHANGELOG.md"
          if (Test-Path $changelogPath) {
            $content = Get-Content $changelogPath -Raw

            # æå–å½“å‰ç‰ˆæœ¬éƒ¨åˆ†ï¼ˆä» [version] åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡é¢˜ï¼‰
            $pattern = "(?s)## \[$version.*?\](.*?)(?=## \[|$)"
            if ($content -match $pattern) {
              $notes = $matches[1].Trim()
            } else {
              $notes = "è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´ã€‚"
            }
          } else {
            $notes = "Avalon Atlas $version å‘å¸ƒç‰ˆæœ¬"
          }

          # æ·»åŠ ä¸‹è½½è¯´æ˜
          $fullNotes = @"
          $notes

          ---

          ## ğŸ“¥ ä¸‹è½½è¯´æ˜

          ### ä¾¿æºç‰ˆï¼ˆæ¨èï¼‰
          ä¸‹è½½ ``AvalonAtlas-$version-portable.zip``ï¼Œè§£å‹ååŒå‡» ``AvalonAtlas.exe`` å³å¯è¿è¡Œã€‚

          **ç³»ç»Ÿè¦æ±‚**ï¼š
          - Windows 10/11 (64ä½)
          - æ— éœ€å®‰è£… Python æˆ–å…¶ä»–ä¾èµ–
          - çº¦ 500MB ç£ç›˜ç©ºé—´

          ### ä½¿ç”¨æŒ‡å—

          è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)

          ### åé¦ˆé—®é¢˜

          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) æäº¤é—®é¢˜æŠ¥å‘Šã€‚
          "@

          # ä¿å­˜åˆ°æ–‡ä»¶ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          $fullNotes | Out-File -FilePath "release_notes.md" -Encoding utf8

          Write-Host "å‘å¸ƒè¯´æ˜å·²ç”Ÿæˆ"

      # 8. åˆ›å»º GitHub Release
      - name: ğŸš€ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Avalon Atlas ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
          files: |
            dist/AvalonAtlas-*.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆä¾›è°ƒè¯•ï¼‰
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        if: always()  # å³ä½¿å¤±è´¥ä¹Ÿä¸Šä¼ ï¼Œä¾¿äºè°ƒè¯•
        with:
          name: AvalonAtlas-${{ github.ref_name }}-build
          path: |
            dist/AvalonAtlas/
            dist/*.zip
          retention-days: 30
          compression-level: 9

      # 10. å‘å¸ƒæˆåŠŸé€šçŸ¥
      - name: âœ… å‘å¸ƒå®Œæˆ
        if: success()
        run: |
          echo "ğŸ‰ å‘å¸ƒæˆåŠŸï¼"
          echo "ç‰ˆæœ¬: ${{ github.ref_name }}"
          echo "ä¸‹è½½é“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
